var index = require('../index.js');
var fs = require('node:fs');
var prompt = require('prompt-sync')();

function loginByEmailOrAppState(error) {
  error ? console.log('Chỉ nhập 1 hoặc 2\n') : null;

  function getAppState(error) {
    error ? console.log('File is not exist\n') : null;
    var name = prompt('File: ').replace(/\s+/g, '');
    var path = __dirname + `/data/${name}.json`;
    if (!fs.existsSync(path)) return getAppState(true, console.clear());
    return { appState: require(path) }
  }

  function getEmailAndPassword() {
    var email = prompt('Email: ');
    var password = prompt('Password: ');
    return { email, password };
  }
  
  var text = prompt('AppState (1) or Email (2): ');
  return text == 1 ? getAppState() : text == 2 ? getEmailAndPassword() : loginByEmailOrAppState(true, console.clear());
}

function loginWithCb() {
  var Opt = loginByEmailOrAppState();
  return index(Opt, /*{
    i_user: '100094261763542'
  }, */async function (err, api) {
    if (err) {
      switch (err.error) {
        case 'submit2FA':
          var code = prompt('Your Code: ').replace(/\s+/g, '').toString();
          return err.continue(code);
        default:
          return;
      }
    }
    fs.writeFileSync(__dirname + '/data/fbstate.json', JSON.stringify(api.getAppState(), null, 2));
    api.sendMessage({ location: { longitude: 1, latitude: 1 } }, 5304583592919650, console.log);
  });
}

function loginWithPromise() {
  var Opt = loginByEmailOrAppState();
  return index(Opt)
    .then(function (api) {
      api.getUserInfo(api.getCurrentUserID(), true, console.log)
    })
    .catch(function (err) {
      switch (err.error) {
        case 'submit2FA':
          var code = prompt('Your Code: ').replace(/\s+/g, '').toString();
          return error.continue(code);
        default:
          return;
      }
    });
}

function chooseLogin() {
  var func = {
    1: loginWithCb,
    2: loginWithPromise
  }
  let text;
  while (typeof func[text] != 'function') {
    text = prompt('Đăng nhập bằng callback (1) or promise (2): ').replace(/\s+/g, '');
    if (typeof func[text] != 'function') {
      console.clear();
      console.log('Chỉ nhập 1 hoặc 2\n');
    }
  }
  try {
    return func[text]();
  } catch (err) {
    return console.log(err);
  }
}
chooseLogin();